# 4 ワンアクション連携

<P> </P>

　


![4_ワンアクション連携.jpg](/files/4_ワンアクション連携.jpg)

次に「ワンアクション連携」を解説します。5250画面を起点として、3通りの手法でWindowsと連携し、画像、地図、Excel、PDFなどを表示します。

*	5250アプリケーション画面のURLホット・スポットのクリックで画像ビューア、あるいは、Google Mapを起動。
*	WRKSPLFにオプションを追加し、スプールファイルをテキスト、または、PDFでWindowsに表示。
*	WRKOBJPDMでPFにユーザー定義オプションを指定・実行すると、Excelが起動してデータが取り込み、表示される。

　

## 4.1 5250ホット･スポット(URLホット･スポット)

ホット・スポットとは、左マウス・ボタンのクリックでコマンドまたは機能を実行できる、セッション・ウィンドウの領域です。

ACSには5種類のホット・スポットがあります。ホット・スポットをマウスでクリックすると、ホット・スポットのタイプに対応したアクションが実行されます。

![4.1_5250ホット･スポット(URLホット･スポット).jpg](/files/4.1_5250ホット･スポット(URLホット･スポット).jpg)

画面上で「http」など、特定のスキーム名で始まる文字列はURLホット・スポットとして解釈されます。サポートされるスキーム名など、ホット・スポットの詳細は、ACSのヘルプを参照ください。

?> ACSのヘルプは、メニューの「ヘルプ」→「インフォメーション・センター」で表示されます。インストーラでデフォルトでインストールしている場合、file:///C:/Users/(Windowsユーザー名)/Documents/IBM/iAccessClient_Help/Emulator/ja/2tabcontents.html が表示されます。

中でも「ファンクション/数字ホット・スポット」は比較的ポピュラーでしょう。一般的な5250画面下部の、「F3」などの文字列がホット・スポットとなり、クリックすると対応する機能キーを実行します。

### <u>ワーク7 URLホット・スポットの使用</u>

**□ W7-1.** コマンド入力画面で「CHGCURLIB LMSExxLIB」を実行。

**□ W7-2.** モダナイズ版の照会アプリケーション「INQRPGM」(RPG/400。5.2.9、5.2.10参照)または「INQRPGLEM」(ILE-RPG。5.2.9、5.2.11参照)のいずれかをCALLコマンドで実行。

**□ W7-3.** 任意のキーで検索を行い、リストからレコードを選択して詳細ウインドゥを表示。

**□ W7-4.** 「画像」のURI(下図➀)をクリックし、Windowsで拡張子「.jpg」に関連付けられたアプリケーションで画像が表示されることを確認。

**□ W7-5.** 「地図」のURI(下図②)をクリックし、「郵便番号」の場所の地図がGoogle MapでWebブラウザに表示されることを確認。

![ワーク7_URLホット・スポットの使用.jpg](/files/ワーク7_URLホット・スポットの使用.jpg)

**□ W7-6.** (オプション1) 他のレコードを検索し、画像や地図の位置が変わるかを確認。

**□ W7-7.** 明細画面に戻り、F1キーを押してヘルプ・ウインドゥを表示し、F8(次ページ)を2回押して「明細のヘルプ（３／３）」を表示。「FILE://」で始まるホット・スポットをクリックし、PDFが表示されることを確認。

**□ W7-8.** (オプション2) DFUやRPGプログラム「EFARPG」(または「EFARPGLE」)で任意のレコードの「郵便番号」を変更し、このレコードを詳細画面で表示してURIをクリックし、Google Mapが変更した郵便番号の場所を表示するか確認。

　

## 4.2 スプールのText/PDF化

スプールファイルを簡単にテキスト、または、PDFでWindowsに表示する方法を解説します。

WRKSPLFの画面からオプション5でスプールの内容を画面に表示するのは、もっとも頻繁に行う操作の一つです。しかし、5250の限られた画面サイズでは帳票の行全体を表示する事はできず、不便に感じることもあるでしょう。

下図の例では、WRKSPLFにオプション「T」と「P」を追加し、「T」で実行すればWindowsのエディターで、「P」で実行すればAcrobatで、スプールをWindowsに表示します。

![4.2_スプールのText_PDF化.jpg](/files/4.2_スプールのText_PDF化.jpg)

WRKSPLF、WRKOUTQ、WRKJOBのスプール一覧画面のオプションに、ユーザー定義アクションを定義する機能はIBM i の6.1で追加されました。ユーザー定義アクションが選択されると関連付けられたプログラムが呼ばれるので、オプションに応じてスプールをテキストやPDFに変換します。

?> PDFへの変換は5770-TS1の「変換−AFPからPDFへの変換」機能を使用しています。

変換されたファイルはIBM i のIFS(統合ファイルシステム)に保管されるので、STRPCCMDでこのファイルをWindowsで開きます。

?> 作成されたテキスト、または、PDFファイルの削除は行っておらず、継続して利用する場合は、別途定期的なディレクトリーのクリーンアップの考慮が必要でしょう。

<P>　</p>

### <u>ワーク8 スプール一覧から印刷出力をテキスト/PDFに変換して表示</u>

**□ W8-1.** コマンド入力画面で「CHGCURLIB LMSExxLIB」を実行。

**□ W8-2.** コマンド「WRKMBRPDM FILE(LMSExxLIB/UDLA)」でメンバー一覧を表示。

**□ W8-3.** ソースファイル「LMSExxLIB/UDLA」のILE-CLプログラム「SPL2PCD」(5.2.12参照)の固定情報を変更。

* 45行目の「/TMP/LMSEXX/」→ 共有名 (例えば「/LMSExx/」など)
* 52行目のIBM i のホスト名「IBMI」→ 使用しているIBM i のホスト名またはIPアドレス
* 72/76行目の1文字リテラル → 1.3「設定情報」に記載した値

**□ W8-4.** PDMのオプション14でメンバー「SHIFT」「SPL2PCD」を作成。

```
                           PDM を使用したメンバーの処理                XXXXXX   
                                                                                
  ファイル.  . . .   UDLA                                                       
    ライブラリー.      LMSExxLIB             位置指定 . . . . . .              
                                                                                
 オプションを入力して，実行キーを押してください。                             
  2= 編集     3=ｺﾋﾟｰ     4= 削除     5= 表示      6= 印刷      7= 名前の変更   
  8= 記述の表示    9= 保管    13=ﾃｷｽﾄ の変更     14=ｺﾝﾊﾟｲﾙ    15=ﾓｼﾞｭｰﾙ 作成.
                                                                                
 OPT  ﾒﾝﾊﾞｰ       ﾀｲﾌﾟ        ﾃｷｽﾄ                                              
      DB2CSV      CLLE         物理ファイルの DATA/FFD を CSV 変換              
      DB2CSVD     DSPF         物理ファイルの DATA/FFD を CSV 変換 - DSPF       
 14   SHIFT       RPGLE        シフト文字にブランク補填 (PC 転送桁ずれ防止 )    
 14   SPL2PCD     CLLE         ユーザー定義リストアクション (SPLF->PC 文書 )   


                                                                                
                                                                                
                                                                       終わり 
 パラメーターまたはコマンド                                                   
 ===>                                                                           
 F3= 終了              F4= プロンプト       F5= 最新表示         F6= 作成      
 F9= コマンドの複写    F10= コマンド入力    F23=ｵﾌﾟｼｮﾝ の続き    F24=ｷｰ の続き 
                                          (C) COPYRIGHT IBM CORP. 1981, 2007.   
```

**□ W8-5.** 権限の低いユーザーでサインオンしている場合はいったんサインオフし、QSECOFRなどの高権限(*ALLOBJおよび*SECADMを持つ)ユーザーでサインオンし、コマンド入力画面を表示。

**□ W8-6.** 下記コマンドを実行して出口プログラムを追加。PGMDTAパラメーターの第3項目には、1.3「設定情報」に記載した文字を指定(テキスト変換用、PDF変換用それぞれ実施)。

```
> ADDEXITPGM EXITPNT(QIBM_QSP_SPLF_LSTACT) FORMAT(LASP0100) PGMNBR(*LOW) PG
  M(LMSExxLIB/SPL2PCD) PGMDTA(*JOB 1 テキスト変換指定文字)         
> ADDEXITPGM EXITPNT(QIBM_QSP_SPLF_LSTACT) FORMAT(LASP0100) PGMNBR(*LOW) PG
  M(LMSExxLIB/SPL2PCD) PGMDTA(*JOB 1 PDF変換指定文字)                     
```

**□ W8-7.** 「WRKREGINF」を実行して「登録情報の処理」画面を表示。画面をスクロールして出口点「QIBM_QSP_SPLF_LSTACT」(テキストは「ﾕｰｻﾞｰ定義のｽﾌﾟｰﾙ･ﾌｧｲﾙ･ﾘｽﾄ」)を見つけ、「OPT」に「8」を入力して実行。

**□ W8-8.** 「出口プログラムの処理」画面で指定したプログラムが出口点に登録されていることを確認。

```
                              出口プログラムの処理                              
                                                                                
出口点 :   QIBM_QSP_SPLF_LSTACT      形式 :   LASP0100                          
                                                                                
オプションを入力して，実行キーを押してください。                              
   1= 追加   4= 除去   5= 表示   10= 置換え                                     
                                                                                
          出口 ﾌﾟﾛｸﾞﾗﾑ      出口                                                
 OPT          番号         ﾌﾟﾛｸﾞﾗﾑ        ﾗｲﾌﾞﾗﾘｰ                               
                                                                                
                    1      SPL2PCD        LMSExxLIB                             
                    2      SPL2PCD        LMSExxLIB                             
                                               
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                       終わり  
コマンド                                                                      
 ===>                                                                           
 F3= 終了   F4=ﾌﾟﾛﾝﾌﾟﾄ   F5= 最新表示   F9= コマンドの複写   F12= 取消し        
```

**□ W8-9.** 高権限ユーザーでサインオンした場合はサインオフし、ハンズオン用のユーザーでサインオンして、WRKSPLFやWRKOUTQなどでスプールの一覧を表示。

**□ W8-10.** スプールファイル一覧の「OPT」に1.3「設定情報」に記載した値を入力して実行し、テキスト、あるいは、PDFがWindowsで表示されることを確認。

?> PDFで一部の文字が正しく表示されない場合があります。例えば半角の「|」が全角になり、桁ずれを起こします(障害か仕様かは不明)。これが問題になる場合は、市販のIBM i 用PDF変換ソフトウェアの検討をお勧めします。

**□ W8-11.** (オプション) 表示されたテキストやPDFをローカル(PC)に保存

 
## 4.3 データのExcel化

IBM i のデータをExcelに変換するには、エミュレーターのデータ転送を使ったり、IBM i 側でCSVに変換してPCにダウンロードしてExcelで読み込むなど、それなりに手間がかかります。Excelに転送した後も、「文字の"1"」が「数字の1」になったり、列幅を調整したりと、何らかの手直しをする事も多いでしょう。

この仕組みでは、PDMにユーザーオプションを追加し、WRKOBJPDMのリストから、PFにこのオプションを指定するだけで、クライアントのPCにExcelが表示されます。

![4.3_データのExcel化.jpg](/files/4.3_データのExcel化.jpg)

図中➀～③のファイルはIBM i のIFS上に作成されます。Windows側のExcel VBAが、NetServer共有、または、FTP転送された、これらファイルの読み込み、ブックの生成、ワークシートの整形、および表示を行います。

?> 作成されたCSVファイルやログなどの削除は行っておらず、継続して利用する場合は、別途定期的なディレクトリーのクリーンアップの考慮が必要でしょう。

レコードやフィールドの選択はしていないので、必要であればIBM i 側で事前にQueryやSQL、CPYFなどでワークファイルを作成しておきます。

誤って大量データをダウンロードすること防止するため、ダウンロード前にウインドゥを表示してオプションなどを指定できます。

![4.3_データのExcel化(2).jpg](/files/4.3_データのExcel化(2).jpg)

<p> </p>

 

### <u>ワーク9 PDMからPFをExcelに変換して表示</u>

**□ W9-1.** コマンド入力画面で「CHGCURLIB LMSExxLIB」を実行。

**□ W9-2.** コマンド「WRKMBRPDM FILE(LMSExxLIB/UDLA)」でメンバー一覧を表示。

**□ W9-3.** ソースファイル「LMSExxLIB/UDLA」のILE-CLプログラム「DB2CSV」(5.2.14参照)の固定情報を変更。

* 44行目の「/TMP/LMSEXX/」→ ワーク用ディレクトリー (例えば「/TMP/LMSExx/」など)
* 16行目と47行目の「LMSExxLIB」→ 1.3「設定情報」の個別設定ライブラリー名
* 48行目のIBM i のホスト名「IBMI」→ 使用しているIBM i のホスト名またはIPアドレス
* 54/55行目の「LMSEXX」→ 1.3「設定情報」で設定したユーザーID/パスワード

**□ W9-4.** PDMのオプション14でメンバー「DB2CSVD」、「DB2CSV」の順で作成。 

**□ W9-5.** 権限の低いユーザーでサインオンしている場合はいったんサインオフし、QSECOFRなどの高権限(\*ALLOBJおよび*SECADMを持つ)ユーザーでサインオンし、コマンド入力画面を表示。

**□ W9-6.** STRPDMコマンドを実行し、「9.ユーザー定義オプションの処理」を実行、「処理するオプション・ファイルの指定」画面が表示されるので、個別のPDM設定を使用していない場合はそのまま実行。

**□ W9-7.** 「ユーザー定義オプションの処理」画面でF6を押し、1.3「設定情報」記載のオプションを2つ追加。FTP用は第3パラメーターに「F」を、NetServer用は第3パラメーターに「N」を指定。

```
                        ユーザー定義オプションの処理                   XXXXXX   
                                                                                
  ファイル  . . . . :   QAUOOPT           メンバー  . . . . :   QAUOOPT         
   ライブラリー . . :     QGPL            位置指定  . . . . :                   
                                                                                
  オプションを入力して，実行キーを押してください。                              
   2= 変更     3= コピー     4= 削除     5= 表示                                
                                                                                
 OPT  ｵﾌﾟｼｮﾝ  ｺﾏﾝﾄﾞ                                                             
        RQ    RUNQRY *N &L/&N                                                   
        SL    SBMJOB ??CMD(SAVLIB LIB(&N))                                      
        SM    SBMJOB ??CMD(SAVOBJ OBJ(&F) LIB(&L) OBJTYPE(*FILE) FILEMBR((&F 
        SO    SBMJOB ??CMD(SAVOBJ OBJ(&N) LIB(&L))                              
        SP    WRKSPLF                                                           
        TX    CALL XXXXLIB/SRC2TXT PARM(&L &F &N)                               
        WS    WRKSBMJOB                                                         
        XF    CALL PGM(LMSEXXLIB/DB2CSV) PARM(&L &N F)                          
        XL    CALL PGM(LMSEXXLIB/DB2CSV) PARM(&L &N N)                          
                                                                        終わり 
  コマンド                                                                      
 ===>                                                                           
 F3= 終了              F4= プロンプト        F5= 最新表示       F6= 作成        
 F9= コマンドの複写    F10= コマンド入力     F24= キーの続き                    
```
                                                                                
**□ W9-8.** 高権限ユーザーでサインオンした場合はサインオフし、ハンズオン用のユーザーでサインオン。

**□ W9-9.** 「WRKOBJPDM LMSExxLIB」を実行。

**□ W9-10.** 「PDMを使用したオブジェクトの処理」画面で、物理ファイル「PERSON」の「OPT」に1.3「設定情報」に記載した値を入力して実行し、NetServer版、またはFTP版のそれぞれで、Excelでデータが表示されることを確認。
 
![ワーク9_PDMからPFをExcelに変換して表示.jpg](/files/ワーク9_PDMからPFをExcelに変換して表示.jpg)

**□ W9-11.** (オプション1) 生成されたExcelの状態を確認。

* データ全体が、オートフィルター付きのテーブルとなる
* 1行目にCOLHDGが表示されている
* 最小限の整形がなされており、数値はカンマ区切りで表示、日付は数値ではなく日付で表示、列幅がある程度調整されている
* 「フィールド記述」シートに物理ファイル「PERSON」のフィールド情報が記録されている

**□ W9-12.** (オプション2) 生成されたExcelをローカル(PC)に保存。

**□ W9-13.** (オプション3) 物理ファイルQEOL/TOKMSPなど、他のPFがExcelに変換されるか確認。

**□ W9-14.** (オプション4) Excel VBAのコードを表示。

手順：Windowsデスクトップの「DB2EXCEL.xlsm」または「DB2EXCELF.xlsm」を直接開き、実行時エラーのダイアログで「終了(E)」をクリック。Excelが表示されている状態でAlt＋F11でVisual Basic Editorを開き、左ペインの「ThisWorkBook」を左ダブルクリック。

![ワーク9_PDMからPFをExcelに変換して表示(2).jpg](/files/ワーク9_PDMからPFをExcelに変換して表示(2).jpg)
